<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playlist Internat - Votes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0f1110;
            --bg-card: #1a1d1b;
            --bg-card-hover: #232725;
            --green-primary: #4ade80;
            --green-secondary: #22c55e;
            --green-dark: #166534;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #2d3230;
            --shadow: rgba(0, 0, 0, 0.4);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1d1b 50%, #0f1912 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 60px;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 16px; }
        
        /* HEADER */
        .header {
            text-align: center; padding: 32px 20px; margin-bottom: 24px;
            background: var(--bg-card); border-radius: 16px;
            border: 1px solid var(--border); animation: fadeInDown 0.6s ease;
            position: relative;
        }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .logo {
            font-size: 2rem; font-weight: 800;
            background: linear-gradient(135deg, var(--green-primary) 0%, var(--green-secondary) 100%);
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent; margin-bottom: 8px; letter-spacing: -0.5px;
        }
        .subtitle { color: var(--text-secondary); font-size: 0.9rem; }
        .admin-lock {
            position: absolute; top: 20px; right: 20px; width: 32px; height: 32px;
            cursor: pointer; opacity: 0.3; transition: all 0.3s ease;
        }
        .admin-lock:hover { opacity: 0.6; transform: scale(1.1); }
        .admin-lock.unlocked { opacity: 1; filter: drop-shadow(0 0 8px var(--green-primary)); }
        
        /* TABS */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: var(--bg-card); padding: 6px; border-radius: 12px; border: 1px solid var(--border); }
        .tab {
            flex: 1; padding: 12px; background: transparent; border: none;
            color: var(--text-secondary); font-size: 0.95rem; font-weight: 600;
            border-radius: 8px; cursor: pointer; transition: all 0.3s ease;
        }
        .tab.active { background: linear-gradient(135deg, var(--green-primary) 0%, var(--green-secondary) 100%); color: var(--bg-dark); box-shadow: 0 4px 12px rgba(74, 222, 128, 0.3); }
        .tab:hover:not(.active) { background: var(--bg-card-hover); color: var(--text-primary); }
        
        /* SECTIONS */
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* SORT CONTROLS */
        .sort-controls {
            display: flex; gap: 8px; margin-bottom: 16px; align-items: center;
            background: var(--bg-card); padding: 8px 12px; border-radius: 8px;
            border: 1px solid var(--border); flex-wrap: wrap;
        }
        .sort-label { font-size: 0.8rem; color: var(--text-secondary); }
        .sort-btn {
            padding: 6px 12px; background: var(--bg-dark); border: 1px solid var(--border);
            border-radius: 6px; font-size: 0.75rem; color: var(--text-secondary);
            cursor: pointer; transition: all 0.2s ease;
        }
        .sort-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .sort-btn.active { background: var(--green-primary); color: var(--bg-dark); border-color: var(--green-primary); }
        
        .download-btn {
            padding: 6px 12px; background: #6366f1; border: 1px solid #4f46e5;
            border-radius: 6px; font-size: 0.75rem; color: white;
            cursor: pointer; transition: all 0.2s ease; margin-left: auto;
        }
        .download-btn:hover { background: #4f46e5; transform: scale(1.05); }
        
        /* SEARCH BOX */
        .search-container { position: relative; margin-bottom: 8px; }
        .search-box {
            width: 100%; padding: 16px 50px 16px 20px; font-size: 1rem;
            background: var(--bg-card); border: 2px solid var(--border);
            border-radius: 12px; color: var(--text-primary); outline: none;
            transition: all 0.3s ease;
        }
        .search-box::placeholder { color: var(--text-secondary); }
        .search-box:focus { border-color: var(--green-primary); box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.1); }
        .search-btn {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--green-primary) 0%, var(--green-secondary) 100%);
            border: none; border-radius: 8px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; transition: all 0.2s ease;
        }
        .search-btn:hover { transform: translateY(-50%) scale(1.05); box-shadow: 0 4px 12px rgba(74, 222, 128, 0.3); }
        .search-btn:active { transform: translateY(-50%) scale(0.98); }
        
        .manual-add-link {
            text-align: right; font-size: 0.75rem; color: var(--text-secondary);
            cursor: pointer; margin-bottom: 20px; opacity: 0.7; transition: opacity 0.2s;
        }
        .manual-add-link:hover { opacity: 1; text-decoration: underline; }
        
        /* RESULTS */
        .results { display: grid; gap: 12px; }
        .track-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 12px; display: flex; gap: 12px;
            align-items: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideIn 0.3s ease; position: relative;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .track-card:hover { background: var(--bg-card-hover); border-color: var(--green-primary); transform: translateX(4px); }
        .track-card.no-preview { opacity: 0.7; }
        .api-badge {
            position: absolute; top: 8px; right: 8px; font-size: 0.65rem;
            padding: 2px 6px; border-radius: 4px; background: var(--bg-dark);
            color: var(--text-secondary); font-weight: 600;
        }
        .track-cover { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; background: var(--bg-dark); flex-shrink: 0; }
        .track-info { flex: 1; min-width: 0; }
        .track-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-artist { color: var(--text-secondary); font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-duration { color: var(--green-primary); font-size: 0.8rem; font-weight: 500; }
        .no-preview-text { color: #ef4444; font-size: 0.7rem; margin-top: 2px; }
        .add-btn {
            padding: 8px 16px; background: linear-gradient(135deg, var(--green-primary) 0%, var(--green-secondary) 100%);
            color: var(--bg-dark); border: none; border-radius: 8px; font-weight: 600;
            font-size: 0.85rem; cursor: pointer; transition: all 0.3s ease; flex-shrink: 0;
        }
        .add-btn:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(74, 222, 128, 0.3); }
        .add-btn:active { transform: scale(0.98); }
        .add-btn.success { background: var(--green-dark); color: var(--green-primary); animation: successPulse 0.6s ease; }
        @keyframes successPulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(74, 222, 128, 0.6); } 100% { transform: scale(1); } }
        
        /* PLAYLIST */
        .playlist-item {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 12px; display: flex; gap: 12px;
            align-items: center; animation: slideIn 0.3s ease; margin-bottom: 8px;
            position: relative;
        }
        .warning-badge { position: absolute; top: 8px; right: 8px; font-size: 1.2rem; animation: pulse 2s infinite; }
        .vote-controls { display: flex; flex-direction: column; gap: 4px; align-items: center; }
        .vote-btn {
            width: 36px; height: 36px; border: none; background: var(--bg-dark);
            border-radius: 8px; cursor: pointer; display: flex; align-items: center;
            justify-content: center; transition: all 0.2s ease; font-size: 1.1rem;
        }
        .vote-btn:hover { transform: scale(1.1); }
        .vote-btn:active { transform: scale(0.95); }
        .vote-btn.upvote:hover { background: var(--green-primary); }
        .vote-btn.downvote:hover { background: #ef4444; }
        .vote-btn.voted { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        .vote-score { font-weight: 700; font-size: 0.9rem; color: var(--green-primary); min-width: 36px; text-align: center; }
        .vote-score.negative { color: #ef4444; }
        
        /* ADMIN CONTROLS */
        .admin-controls { display: none; gap: 4px; flex-direction: column; }
        .admin-controls.active { display: flex; }
        .admin-btn { padding: 6px 12px; border: none; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .delete-btn { background: #ef4444; color: white; }
        .delete-btn:hover { background: #dc2626; transform: scale(1.05); }
        .replace-btn { background: #f59e0b; color: white; }
        .replace-btn:hover { background: #d97706; transform: scale(1.05); }
        .info-btn { background: #3b82f6; color: white; font-size: 0.85rem; width: 28px; height: 28px; padding: 0; display: flex; align-items: center; justify-content: center; }
        .info-btn:hover { background: #2563eb; }
        
        /* AUDIO PLAYER */
        .play-preview {
            width: 36px; height: 36px; background: var(--green-primary); border: none;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center;
            justify-content: center; transition: all 0.2s ease; color: var(--bg-dark); font-size: 0.9rem;
        }
        .play-preview:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(74, 222, 128, 0.4); }
        .play-preview.playing { background: #ef4444; animation: pulse 1.5s infinite; }
        .play-preview:disabled { background: var(--border); cursor: not-allowed; opacity: 0.5; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        /* MODAL */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.8); z-index: 2000; align-items: center;
            justify-content: center; backdrop-filter: blur(8px); animation: fadeIn 0.3s ease;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-card); border-radius: 16px; padding: 24px; max-width: 600px;
            width: 90%; max-height: 85vh; overflow-y: auto; border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); animation: slideInUp 0.3s ease;
        }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.2rem; font-weight: 700; }
        .modal-close {
            width: 32px; height: 32px; background: var(--bg-dark); border: none;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center;
            justify-content: center; font-size: 1.2rem; color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        .modal-close:hover { background: #ef4444; color: white; transform: scale(1.1); }
        .modal-search { margin-bottom: 16px; }
        .modal-results { display: grid; gap: 8px; max-height: 400px; overflow-y: auto; }
        .modal-track {
            background: var(--bg-dark); padding: 12px; border-radius: 8px; display: flex;
            gap: 12px; align-items: center; cursor: pointer; transition: all 0.2s ease;
            border: 1px solid transparent; position: relative;
        }
        .modal-track:hover { border-color: var(--green-primary); background: var(--bg-card-hover); }
        .modal-track-cover { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; }
        
        /* MANUAL ADD FORM */
        .manual-form { display: grid; gap: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-label { font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; }
        .form-input {
            padding: 12px; background: var(--bg-dark); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text-primary); font-size: 0.95rem; outline: none;
            transition: all 0.2s ease;
        }
        .form-input:focus { border-color: var(--green-primary); box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.1); }
        .form-submit {
            padding: 12px 24px; background: linear-gradient(135deg, var(--green-primary) 0%, var(--green-secondary) 100%);
            color: var(--bg-dark); border: none; border-radius: 8px; font-weight: 600;
            font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease;
        }
        .form-submit:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(74, 222, 128, 0.3); }
        
        /* INFO MODAL */
        .info-content { padding: 16px 0; }
        .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .info-label { color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; }
        .info-value { color: var(--text-primary); font-size: 0.9rem; text-align: right; }
        
        /* LOADING */
        .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
        .spinner {
            display: inline-block; width: 40px; height: 40px; border: 3px solid var(--border);
            border-top-color: var(--green-primary); border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }
        
        /* FOOTER */
        .footer { text-align: center; padding: 20px; color: var(--text-secondary); font-size: 0.75rem; margin-top: 40px; opacity: 0.6; }
        
        /* NOTIFICATION */
        .notification {
            position: fixed; bottom: 20px; right: 20px; background: var(--bg-card);
            border: 1px solid var(--green-primary); border-radius: 12px; padding: 16px 20px;
            box-shadow: 0 8px 24px var(--shadow); z-index: 1000; animation: slideInRight 0.3s ease;
            max-width: 300px;
        }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        .notification.success { border-color: var(--green-primary); }
        .notification.error { border-color: #ef4444; }
        
        /* RESPONSIVE */
        @media (max-width: 600px) {
            .container { padding: 12px; }
            .header { padding: 24px 16px; }
            .logo { font-size: 1.6rem; }
            .track-cover, .modal-track-cover { width: 50px; height: 50px; }
            .track-title { font-size: 0.9rem; }
            .track-artist { font-size: 0.8rem; }
            .sort-controls { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="admin-lock" id="adminLock" title="Mode Admin">üîí</div>
            <h1 class="logo">üéµ Playlist Internat</h1>
            <p class="subtitle">Ajoute tes sons et vote pour tes pr√©f√©r√©s !</p>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" data-tab="search">üîç Rechercher</button>
            <button class="tab" data-tab="playlist">üìã Playlist (<span id="playlistCount">0</span>)</button>
        </div>

        <!-- SEARCH SECTION -->
        <div class="section active" id="searchSection">
            <div class="search-container">
                <input type="text" class="search-box" id="searchInput" placeholder="Rechercher un titre, artiste...">
                <button class="search-btn" id="searchBtn">
                    <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                </button>
            </div>
            <div class="manual-add-link" id="manualAddLink">+ Ajout manuel</div>
            <div class="results" id="results"></div>
        </div>

        <!-- PLAYLIST SECTION -->
        <div class="section" id="playlistSection">
            <div class="sort-controls">
                <span class="sort-label">üîΩ Trier par :</span>
                <button class="sort-btn active" data-sort="score">Notes</button>
                <button class="sort-btn" data-sort="title">Titre</button>
                <button class="sort-btn" data-sort="artist">Artiste</button>
                <button class="sort-btn" data-sort="date">Date d'ajout</button>
                <button class="sort-btn" data-sort="duration">Dur√©e</button>
                <button class="download-btn" id="downloadBtn" style="display: none;">üì• T√©l√©charger</button>
            </div>
            <div id="playlistContent"></div>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
        Fait avec ‚ù§Ô∏è par No√© - 2026
    </div>

    <!-- MANUAL ADD MODAL -->
    <div class="modal" id="manualModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚ûï Ajout manuel</div>
                <button class="modal-close" id="manualModalClose">‚úï</button>
            </div>
            <form class="manual-form" id="manualForm">
                <div class="form-group">
                    <label class="form-label">Titre *</label>
                    <input type="text" class="form-input" id="manualTitle" placeholder="Ex: LOVE YOU" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Artiste *</label>
                    <input type="text" class="form-input" id="manualArtist" placeholder="Ex: nono la grinta" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Album (optionnel)</label>
                    <input type="text" class="form-input" id="manualAlbum" placeholder="Ex: Album">
                </div>
                <div class="form-group">
                    <label class="form-label">Dur√©e en secondes (optionnel)</label>
                    <input type="number" class="form-input" id="manualDuration" placeholder="Ex: 200">
                </div>
                <button type="submit" class="form-submit">Ajouter √† la playlist</button>
            </form>
        </div>
    </div>

    <!-- REPLACE MODAL -->
    <div class="modal" id="replaceModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üîÑ Remplacer le titre</div>
                <button class="modal-close" id="modalClose">‚úï</button>
            </div>
            <div class="modal-search">
                <input type="text" class="search-box" id="modalSearchInput" placeholder="Rechercher un remplacement...">
            </div>
            <div class="modal-results" id="modalResults"></div>
        </div>
    </div>

    <!-- INFO MODAL -->
    <div class="modal" id="infoModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚ÑπÔ∏è Informations du titre</div>
                <button class="modal-close" id="infoModalClose">‚úï</button>
            </div>
            <div class="info-content" id="infoContent"></div>
        </div>
    </div>

    <!-- AUDIO ELEMENT -->
    <audio id="audioPlayer" playsinline></audio>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // ===== FIREBASE CONFIG =====
        const firebaseConfig = {
            apiKey: "AIzaSyC7IaaSbME1fEsmqiYBLcQTHJvZ3kzsGbQ",
            authDomain: "lecturo-42f9e.firebaseapp.com",
            databaseURL: "https://lecturo-42f9e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "lecturo-42f9e",
            storageBucket: "lecturo-42f9e.firebasestorage.app",
            messagingSenderId: "372170075148",
            appId: "1:372170075148:web:79d682e34b1d015ff15229",
            measurementId: "G-Y2LRWZMFY1"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const playlistRef = database.ref('playlist');

        // ===== API KEYS =====
        const SPOTIFY_CLIENT_ID = '852a96ff36034aee9a900d915422f1c3';
        const SPOTIFY_CLIENT_SECRET = '14f0fc4d438a45a7976acb8968cfff92';
        const YOUTUBE_API_KEY = 'AIzaSyARrkrnQPA5d3GJ3fCbFKXeZHILEA-zzWY';
        
        let spotifyToken = null;

        // ===== GET SPOTIFY TOKEN =====
        async function getSpotifyToken() {
            if (spotifyToken) return spotifyToken;
            
            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(SPOTIFY_CLIENT_ID + ':' + SPOTIFY_CLIENT_SECRET),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: 'grant_type=client_credentials'
                });
                
                const data = await response.json();
                spotifyToken = data.access_token;
                
                // Rafra√Æchir le token avant expiration
                setTimeout(() => {
                    spotifyToken = null;
                    getSpotifyToken();
                }, (data.expires_in * 1000) - 60000);
                
                return spotifyToken;
            } catch (error) {
                console.warn('Spotify token error:', error);
                return null;
            }
        }

        // ===== ADMIN LOGIN LOGIC =====
        const OBFUSCATED_KEY = "0304";
        let isAdmin = false;
        let trackToReplace = null;
        let currentSortMethod = 'score';

        function verifyAdminCode(input) {
            if (input.length !== 4) return false;
            let derivedCode = "";
            for (let i = 0; i < OBFUSCATED_KEY.length; i++) {
                let digit = parseInt(OBFUSCATED_KEY[i]);
                if (i % 2 !== 0) {
                    derivedCode += (digit - 1).toString();
                } else {
                    derivedCode += digit.toString();
                }
            }
            return input === derivedCode;
        }

        async function promptAdminLogin() {
            const password = prompt('üîê Mot de passe admin :');
            if (!password) return;

            if (verifyAdminCode(password)) {
                isAdmin = true;
                document.getElementById('adminLock').classList.add('unlocked');
                document.getElementById('adminLock').textContent = 'üîì';
                document.getElementById('downloadBtn').style.display = 'block';
                showNotification('‚úÖ Mode admin activ√© !', 'success');
                loadPlaylist();
            } else {
                showNotification('‚ùå Mot de passe incorrect', 'error');
            }
        }

        document.getElementById('adminLock').addEventListener('click', promptAdminLogin);

        // ===== DOWNLOAD PLAYLIST =====
        document.getElementById('downloadBtn').addEventListener('click', () => {
            const tracks = Object.values(playlistData);
            
            if (tracks.length === 0) {
                showNotification('Playlist vide !', 'error');
                return;
            }

            // Tri par score
            tracks.sort((a, b) => (b.score || 0) - (a.score || 0));

            let txtContent = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            txtContent += '       PLAYLIST INTERNAT üéµ\n';
            txtContent += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            txtContent += `üìä Total: ${tracks.length} titre(s)\n`;
            txtContent += `üìÖ Export√© le: ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}\n\n`;
            txtContent += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';

            tracks.forEach((track, index) => {
                txtContent += `${(index + 1).toString().padStart(2, '0')}. ${track.title}\n`;
                txtContent += `    üé§ ${track.artist}\n`;
                if (track.album && track.album !== 'Album inconnu') {
                    txtContent += `    üíø ${track.album}\n`;
                }
                txtContent += `    ‚≠ê Score: ${track.score || 0} | ‚è±Ô∏è ${formatDuration(track.duration)}\n`;
                txtContent += `    üì° Source: ${track.api || 'Ancienne'}\n`;
                txtContent += '\n';
            });

            txtContent += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            txtContent += '   Fait avec ‚ù§Ô∏è par No√© - 2026\n';
            txtContent += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';

            const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `playlist_internat_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('‚úÖ Playlist t√©l√©charg√©e !', 'success');
        });

        // ===== LOCALSTORAGE VOTE TRACKING =====
        function hasVoted(trackId, voteType) {
            const votes = JSON.parse(localStorage.getItem('votes') || '{}');
            return votes[trackId] === voteType;
        }

        function recordVote(trackId, voteType) {
            const votes = JSON.parse(localStorage.getItem('votes') || '{}');
            votes[trackId] = voteType;
            localStorage.setItem('votes', JSON.stringify(votes));
        }

        function getVoteStatus(trackId) {
            const votes = JSON.parse(localStorage.getItem('votes') || '{}');
            return votes[trackId] || null;
        }

        // ===== DETECT OLD API =====
        function isOldAPI(track) {
            if (!track.preview) return true;
            if (track.preview.includes('deezer')) return true;
            if (track.preview.includes('dzcdn')) return true;
            return false;
        }

        // ===== VARIABLES GLOBALES =====
        let currentPlayingBtn = null;
        let playlistData = {};
        let currentPlayingUrl = null;
        let audioUnlocked = false;

        // ===== ELEMENTS DOM =====
        const tabs = document.querySelectorAll('.tab');
        const sections = document.querySelectorAll('.section');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const results = document.getElementById('results');
        const playlistContent = document.getElementById('playlistContent');
        const playlistCount = document.getElementById('playlistCount');
        const audioPlayer = document.getElementById('audioPlayer');
        const replaceModal = document.getElementById('replaceModal');
        const modalClose = document.getElementById('modalClose');
        const modalSearchInput = document.getElementById('modalSearchInput');
        const modalResults = document.getElementById('modalResults');
        const infoModal = document.getElementById('infoModal');
        const infoModalClose = document.getElementById('infoModalClose');
        const infoContent = document.getElementById('infoContent');
        const sortBtns = document.querySelectorAll('.sort-btn');
        const manualAddLink = document.getElementById('manualAddLink');
        const manualModal = document.getElementById('manualModal');
        const manualModalClose = document.getElementById('manualModalClose');
        const manualForm = document.getElementById('manualForm');

        // ===== UNLOCK AUDIO FOR MOBILE =====
        function unlockAudio() {
            if (audioUnlocked) return;
            
            const unlock = () => {
                audioPlayer.play().then(() => {
                    audioPlayer.pause();
                    audioPlayer.currentTime = 0;
                    audioUnlocked = true;
                }).catch(() => {});
            };

            document.addEventListener('touchstart', unlock, { once: true });
            document.addEventListener('click', unlock, { once: true });
        }

        unlockAudio();

        // ===== TABS NAVIGATION =====
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                tabs.forEach(t => t.classList.remove('active'));
                sections.forEach(s => s.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${targetTab}Section`).classList.add('active');

                if (targetTab === 'playlist') {
                    loadPlaylist();
                }
            });
        });

        // ===== SORT CONTROLS =====
        sortBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                sortBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSortMethod = btn.dataset.sort;
                loadPlaylist();
            });
        });

        // ===== MANUAL ADD =====
        manualAddLink.addEventListener('click', () => {
            manualModal.classList.add('active');
        });

        manualModalClose.addEventListener('click', () => {
            manualModal.classList.remove('active');
            manualForm.reset();
        });

        manualModal.addEventListener('click', (e) => {
            if (e.target === manualModal) {
                manualModal.classList.remove('active');
                manualForm.reset();
            }
        });

        manualForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const title = document.getElementById('manualTitle').value.trim();
            const artist = document.getElementById('manualArtist').value.trim();
            const album = document.getElementById('manualAlbum').value.trim();
            const duration = parseInt(document.getElementById('manualDuration').value) || 180;

            if (!title || !artist) {
                showNotification('Titre et artiste requis !', 'error');
                return;
            }

            const track = {
                id: `manual_${Date.now()}`,
                title: title,
                artist: artist,
                album: album || 'Album inconnu',
                cover: 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%231a1d1b%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23fff%22 font-size=%2240%22%3E%F0%9F%8E%B5%3C/text%3E%3C/svg%3E',
                duration: duration,
                preview: null,
                explicit: false,
                api: 'Manuel',
                score: 0,
                addedAt: Date.now()
            };

            database.ref(`playlist/${track.id}`).set(track).then(() => {
                showNotification(`‚úÖ "${title}" ajout√© !`, 'success');
                manualModal.classList.remove('active');
                manualForm.reset();
            }).catch(error => {
                console.error('Erreur ajout:', error);
                showNotification('Erreur d\'ajout', 'error');
            });
        });

        // ===== DEBOUNCE FUNCTION =====
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // ===== SEARCH ALL APIS WITH PRIORITY =====
        async function searchAllAPIs(query, limit = 30) {
            if (!query.trim() || query.length < 2) {
                if (query.length > 0) {
                    results.innerHTML = '<div class="empty-state"><div class="empty-icon">‚å®Ô∏è</div><p>Tape au moins 2 lettres...</p></div>';
                } else {
                    results.innerHTML = '';
                }
                return [];
            }
        
            showLoading(results);
        
            const spotifyResults = [];
            const youtubeResults = [];
            const itunesResults = [];
            const deezerResults = [];
            
            let spotifyOk = false;
            let youtubeOk = false;
            let itunesOk = false;
            let deezerOk = false;
        
            // 1. SPOTIFY API (PRIORITAIRE)
            try {
                const token = await getSpotifyToken();
                if (token) {
                    const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&market=FR&limit=${limit}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        spotifyResults.push(...(data.tracks.items || []).map(track => ({
                            id: `spotify_${track.id}`,
                            originalId: track.id,
                            title: track.name,
                            artist: track.artists.map(a => a.name).join(', '),
                            cover: track.album.images[1]?.url || track.album.images[0]?.url,
                            duration: Math.floor(track.duration_ms / 1000),
                            preview: track.preview_url,
                            explicit: track.explicit,
                            api: 'Spotify',
                            album: track.album.name,
                            releaseDate: track.album.release_date,
                            popularity: track.popularity
                        })));
                        spotifyOk = true;
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Spotify non disponible');
            }
        
            // 2. YOUTUBE DATA API (PRIORITAIRE)
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query + ' audio')}&type=video&videoCategoryId=10&maxResults=${limit}&key=${YOUTUBE_API_KEY}`);
                
                if (response.ok) {
                    const data = await response.json();
                    youtubeResults.push(...(data.items || []).map(item => ({
                        id: `youtube_${item.id.videoId}`,
                        originalId: item.id.videoId,
                        title: item.snippet.title.replace(/\(Official.*?\)/gi, '').replace(/\[.*?\]/g, '').trim(),
                        artist: item.snippet.channelTitle.replace(' - Topic', '').trim(),
                        cover: item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default.url,
                        duration: 180,
                        preview: null,
                        explicit: false,
                        api: 'YouTube',
                        album: 'YouTube'
                    })));
                    youtubeOk = true;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è YouTube non disponible');
            }
        
            // 3. iTunes API (BACKUP)
            try {
                const response = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&entity=song&country=FR&limit=${limit}`);
                if (response.ok) {
                    const data = await response.json();
                    itunesResults.push(...(data.results || []).map(track => ({
                        id: `itunes_${track.trackId}`,
                        originalId: track.trackId,
                        title: track.trackName,
                        artist: track.artistName,
                        cover: track.artworkUrl100,
                        duration: Math.floor(track.trackTimeMillis / 1000),
                        preview: track.previewUrl,
                        explicit: track.trackExplicitness === 'explicit',
                        api: 'iTunes',
                        album: track.collectionName,
                        releaseDate: track.releaseDate,
                        genre: track.primaryGenreName
                    })));
                    itunesOk = true;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è iTunes non disponible');
            }
        
            // 4. Deezer API (BACKUP)
            try {
                const response = await fetch(`https://api.deezer.com/search?q=${encodeURIComponent(query)}&limit=${limit}`);
                if (response.ok) {
                    const data = await response.json();
                    deezerResults.push(...(data.data || []).map(track => ({
                        id: `deezer_${track.id}`,
                        originalId: track.id,
                        title: track.title,
                        artist: track.artist.name,
                        cover: track.album.cover_medium,
                        duration: track.duration,
                        preview: track.preview,
                        explicit: track.explicit_lyrics,
                        api: 'Deezer',
                        album: track.album.title
                    })));
                    deezerOk = true;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Deezer non disponible');
            }
        
            // V√©rifier si au moins une API a r√©pondu
            const atLeastOneApiWorking = spotifyOk || youtubeOk || itunesOk || deezerOk;
            
            if (!atLeastOneApiWorking) {
                // AUCUNE API n'a r√©pondu = erreur de connexion
                results.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <p style="color: #ef4444; font-weight: 600;">Erreur de connexion</p>
                        <p style="font-size: 0.85rem; margin-top: 8px;">Impossible de contacter les APIs musicales.<br>V√©rifie ta connexion internet.</p>
                    </div>
                `;
                return [];
            }
        
            // PRIORISATION : 10 premiers = Spotify/YouTube en altern√©, puis le reste = iTunes/Deezer en altern√©
            const merged = [];
            
            // 10 premiers r√©sultats : Spotify et YouTube en alternance
            const priorityCount = 10;
            for (let i = 0; i < priorityCount; i++) {
                if (spotifyResults[Math.floor(i/2)]) merged.push(spotifyResults[Math.floor(i/2)]);
                if (i+1 < priorityCount && youtubeResults[Math.floor(i/2)]) merged.push(youtubeResults[Math.floor(i/2)]);
            }
            
            // Reste des r√©sultats : tous en alternance
            const maxLength = Math.max(
                spotifyResults.length, 
                youtubeResults.length, 
                itunesResults.length, 
                deezerResults.length
            );
            
            for (let i = Math.floor(priorityCount/2); i < maxLength; i++) {
                if (spotifyResults[i]) merged.push(spotifyResults[i]);
                if (youtubeResults[i]) merged.push(youtubeResults[i]);
                if (itunesResults[i]) merged.push(itunesResults[i]);
                if (deezerResults[i]) merged.push(deezerResults[i]);
            }
        
            if (merged.length > 0) {
                displayMixedResults(merged);
                return merged;
            } else {
                // Au moins une API a r√©pondu mais aucun r√©sultat trouv√©
                const workingApis = [];
                if (spotifyOk) workingApis.push('Spotify');
                if (youtubeOk) workingApis.push('YouTube');
                if (itunesOk) workingApis.push('iTunes');
                if (deezerOk) workingApis.push('Deezer');
                
                results.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <p>Aucun r√©sultat trouv√©</p>
                        <p style="font-size: 0.8rem; margin-top: 8px; opacity: 0.7;">Recherche effectu√©e sur : ${workingApis.join(', ')}</p>
                    </div>
                `;
                return [];
            }
        }


        // D√âLAI DE 2 SECONDES pour la recherche automatique
        const debouncedSearch = debounce(searchAllAPIs, 2000);

        function displayMixedResults(tracks) {
            if (tracks.length === 0) {
                results.innerHTML = '<div class="empty-state"><div class="empty-icon">üîç</div><p>Aucun r√©sultat trouv√©</p></div>';
                return;
            }

            results.innerHTML = tracks.map(track => {
                const hasPreview = !!track.preview;
                const cardClass = hasPreview ? 'track-card' : 'track-card no-preview';
                
                return `
                <div class="${cardClass}">
                    <div class="api-badge">${track.api}</div>
                    <img src="${track.cover}" alt="${track.title}" class="track-cover" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%231a1d1b%22 width=%22100%22 height=%22100%22/%3E%3C/svg%3E'">
                    <div class="track-info">
                        <div class="track-title">${escapeHtml(track.title)} ${track.explicit ? 'üÖ¥' : ''}</div>
                        <div class="track-artist">${escapeHtml(track.artist)}</div>
                        <div class="track-duration">${formatDuration(track.duration)}</div>
                        ${!hasPreview ? '<div class="no-preview-text">‚ö†Ô∏è Pr√©visualisation indisponible</div>' : ''}
                    </div>
                    ${hasPreview ? `
                        <button class="play-preview" data-url="${track.preview}">
                            ‚ñ∂
                        </button>
                    ` : `
                        <button class="play-preview" disabled>
                            ‚è∏
                        </button>
                    `}
                    <button class="add-btn" data-track='${JSON.stringify(track).replace(/'/g, "&apos;")}'>
                        + Ajouter
                    </button>
                </div>
            `}).join('');

            document.querySelectorAll('.play-preview:not(:disabled)').forEach(btn => {
                btn.addEventListener('click', function() {
                    playPreview(this.dataset.url, this);
                });
            });

            document.querySelectorAll('.add-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    addToPlaylist(JSON.parse(this.dataset.track.replace(/&apos;/g, "'")), this);
                });
            });
        }

        // ===== PREVIEW AUDIO =====
        function playPreview(url, btn) {
            if (audioPlayer.src === url && !audioPlayer.paused) {
                audioPlayer.pause();
                btn.innerHTML = '‚ñ∂';
                btn.classList.remove('playing');
                currentPlayingBtn = null;
                currentPlayingUrl = null;
            } else {
                if (currentPlayingBtn) {
                    currentPlayingBtn.innerHTML = '‚ñ∂';
                    currentPlayingBtn.classList.remove('playing');
                }
                
                audioPlayer.pause();
                audioPlayer.src = url;
                audioPlayer.load();
                currentPlayingUrl = url;
                
                const playPromise = audioPlayer.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        btn.innerHTML = '‚è∏';
                        btn.classList.add('playing');
                        currentPlayingBtn = btn;
                    }).catch((error) => {
                        console.log('Erreur lecture:', error);
                        btn.innerHTML = '‚ñ∂';
                        btn.classList.remove('playing');
                        currentPlayingUrl = null;
                    });
                }

                audioPlayer.onended = () => {
                    btn.innerHTML = '‚ñ∂';
                    btn.classList.remove('playing');
                    currentPlayingBtn = null;
                    currentPlayingUrl = null;
                };

                audioPlayer.onpause = () => {
                    if (audioPlayer.src === url && currentPlayingBtn === btn) {
                        currentPlayingUrl = null;
                    }
                };
            }
        }

        // ===== ADD TO PLAYLIST =====
        function addToPlaylist(track, btn) {
            database.ref(`playlist/${track.id}`).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    showNotification('Ce titre est d√©j√† dans la playlist !', 'error');
                } else {
                    database.ref(`playlist/${track.id}`).set({
                        ...track,
                        score: 0,
                        addedAt: Date.now()
                    }).then(() => {
                        const originalText = btn.textContent;
                        btn.classList.add('success');
                        btn.textContent = '‚úì Ajout√© !';
                        
                        setTimeout(() => {
                            btn.classList.remove('success');
                            btn.textContent = originalText;
                        }, 2000);

                        showNotification(`‚úÖ "${track.title}" ajout√© !`, 'success');
                    }).catch(error => {
                        console.error('Erreur Firebase:', error);
                        showNotification('Erreur d\'ajout', 'error');
                    });
                }
            });
        }

        // ===== DELETE TRACK (ADMIN) =====
        function deleteTrack(trackId) {
            if (!isAdmin) return;
            
            if (confirm('üóëÔ∏è Supprimer ce titre de la playlist ?')) {
                database.ref(`playlist/${trackId}`).remove().then(() => {
                    showNotification('‚úÖ Titre supprim√© !', 'success');
                }).catch(error => {
                    console.error('Erreur suppression:', error);
                    showNotification('Erreur de suppression', 'error');
                });
            }
        }

        // ===== SHOW TRACK INFO =====
        function showTrackInfo(track) {
            const infoHTML = `
                <div class="info-row">
                    <div class="info-label">Titre</div>
                    <div class="info-value">${escapeHtml(track.title)}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Artiste</div>
                    <div class="info-value">${escapeHtml(track.artist)}</div>
                </div>
                ${track.album ? `
                <div class="info-row">
                    <div class="info-label">Album</div>
                    <div class="info-value">${escapeHtml(track.album)}</div>
                </div>
                ` : ''}
                <div class="info-row">
                    <div class="info-label">Dur√©e</div>
                    <div class="info-value">${formatDuration(track.duration)}</div>
                </div>
                ${track.releaseDate ? `
                <div class="info-row">
                    <div class="info-label">Date de sortie</div>
                    <div class="info-value">${new Date(track.releaseDate).toLocaleDateString('fr-FR')}</div>
                </div>
                ` : ''}
                ${track.genre ? `
                <div class="info-row">
                    <div class="info-label">Genre</div>
                    <div class="info-value">${escapeHtml(track.genre)}</div>
                </div>
                ` : ''}
                ${track.popularity ? `
                <div class="info-row">
                    <div class="info-label">Popularit√©</div>
                    <div class="info-value">${track.popularity}/100</div>
                </div>
                ` : ''}
                <div class="info-row">
                    <div class="info-label">Source API</div>
                    <div class="info-value">${track.api || 'Ancien'}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Score</div>
                    <div class="info-value">${track.score || 0} votes</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Ajout√© le</div>
                    <div class="info-value">${new Date(track.addedAt || Date.now()).toLocaleDateString('fr-FR')}</div>
                </div>
            `;
            
            infoContent.innerHTML = infoHTML;
            infoModal.classList.add('active');
        }

        infoModalClose.addEventListener('click', () => {
            infoModal.classList.remove('active');
        });

        // ===== REPLACE TRACK (ADMIN) =====
        function openReplaceModal(track) {
            if (!isAdmin) return;
            
            trackToReplace = track;
            replaceModal.classList.add('active');
            modalSearchInput.value = `${track.artist} ${track.title}`;
            searchInModal(`${track.artist} ${track.title}`);
        }

        async function searchInModal(query) {
            if (!query.trim()) {
                modalResults.innerHTML = '';
                return;
            }

            modalResults.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            const tracks = await searchAllAPIs(query, 20);
            
            if (tracks.length > 0) {
                displayModalResults(tracks);
            } else {
                modalResults.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Aucun r√©sultat</div>';
            }
        }

        function displayModalResults(tracks) {
            modalResults.innerHTML = tracks.map(track => {
                const hasPreview = !!track.preview;
                return `
                <div class="modal-track">
                    <div class="api-badge">${track.api}</div>
                    <img src="${track.cover}" alt="${track.title}" class="modal-track-cover">
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${escapeHtml(track.title)} ${track.explicit ? 'üÖ¥' : ''}
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${escapeHtml(track.artist)}
                        </div>
                        <div style="color: var(--green-primary); font-size: 0.75rem;">
                            ${formatDuration(track.duration)}
                        </div>
                        ${!hasPreview ? '<div style="color: #ef4444; font-size: 0.7rem; margin-top: 2px;">‚ö†Ô∏è Pas de preview</div>' : ''}
                    </div>
                    ${hasPreview ? `
                        <button class="play-preview" data-url="${track.preview}" onclick="event.stopPropagation(); playPreview('${track.preview}', this);">
                            ‚ñ∂
                        </button>
                    ` : ''}
                    <button class="add-btn" onclick='event.stopPropagation(); replaceTrackWith(${JSON.stringify(track).replace(/'/g, "&apos;")})' style="font-size: 0.75rem; padding: 6px 12px;">
                        Choisir
                    </button>
                </div>
            `}).join('');
        }

        async function replaceTrackWith(newTrack) {
            if (!trackToReplace) return;

            const updatedTrack = {
                ...newTrack,
                score: trackToReplace.score || 0,
                addedAt: trackToReplace.addedAt || Date.now()
            };

            try {
                await database.ref(`playlist/${trackToReplace.id}`).remove();
                await database.ref(`playlist/${newTrack.id}`).set(updatedTrack);
                
                showNotification('‚úÖ Titre remplac√© !', 'success');
                closeReplaceModal();
                loadPlaylist();
            } catch (error) {
                console.error('Erreur remplacement:', error);
                showNotification('Erreur de remplacement', 'error');
            }
        }

        function closeReplaceModal() {
            replaceModal.classList.remove('active');
            trackToReplace = null;
            modalSearchInput.value = '';
            modalResults.innerHTML = '';
        }

        modalClose.addEventListener('click', closeReplaceModal);

        modalSearchInput.addEventListener('input', debounce((e) => {
            searchInModal(e.target.value);
        }, 2000));

        replaceModal.addEventListener('click', (e) => {
            if (e.target === replaceModal) closeReplaceModal();
        });

        infoModal.addEventListener('click', (e) => {
            if (e.target === infoModal) infoModal.classList.remove('active');
        });

        // ===== VOTE SYSTEM =====
        function vote(trackId, value, btn) {
            const voteType = value > 0 ? 'up' : 'down';
            
            if (hasVoted(trackId, voteType)) {
                showNotification('Tu as d√©j√† vot√© pour ce titre !', 'error');
                return;
            }

            const trackRef = database.ref(`playlist/${trackId}`);
            
            trackRef.transaction((track) => {
                if (track) {
                    track.score = (track.score || 0) + value;
                }
                return track;
            }).then(() => {
                recordVote(trackId, voteType);
                showNotification(value > 0 ? 'üëç Vote enregistr√© !' : 'üëé Vote enregistr√© !', 'success');
            });
        }

        // ===== LOAD PLAYLIST =====
        function loadPlaylist() {
            showLoading(playlistContent);

            playlistRef.on('value', (snapshot) => {
                playlistData = snapshot.val() || {};
                let tracks = Object.values(playlistData);

                if (tracks.length === 0) {
                    playlistContent.innerHTML = '<div class="empty-state"><div class="empty-icon">üéµ</div><p>La playlist est vide.<br>Ajoute des sons !</p></div>';
                    playlistCount.textContent = '0';
                    return;
                }

                // Tri selon m√©thode choisie
                switch(currentSortMethod) {
                    case 'score':
                        tracks.sort((a, b) => (b.score || 0) - (a.score || 0));
                        break;
                    case 'title':
                        tracks.sort((a, b) => a.title.localeCompare(b.title));
                        break;
                    case 'artist':
                        tracks.sort((a, b) => a.artist.localeCompare(b.artist));
                        break;
                    case 'date':
                        tracks.sort((a, b) => (b.addedAt || 0) - (a.addedAt || 0));
                        break;
                    case 'duration':
                        tracks.sort((a, b) => (a.duration || 0) - (b.duration || 0));
                        break;
                }

                playlistCount.textContent = tracks.length;

                playlistContent.innerHTML = tracks.map(track => {
                    const voteStatus = getVoteStatus(track.id);
                    const upvoteClass = voteStatus === 'up' ? 'voted' : '';
                    const downvoteClass = voteStatus === 'down' ? 'voted' : '';
                    
                    const isPlaying = currentPlayingUrl === track.preview && !audioPlayer.paused;
                    const playBtnIcon = isPlaying ? '‚è∏' : '‚ñ∂';
                    const playBtnClass = isPlaying ? 'playing' : '';

                    const isOld = isOldAPI(track);
                    const hasPreview = !!track.preview;

                    return `
                    <div class="playlist-item">
                        ${isOld ? '<div class="warning-badge" title="Ancienne API ou preview indisponible">‚ö†Ô∏è</div>' : ''}
                        <div class="vote-controls">
                            <button class="vote-btn upvote ${upvoteClass}" data-id="${track.id}" data-value="1">
                                üëç
                            </button>
                            <div class="vote-score ${track.score < 0 ? 'negative' : ''}">
                                ${track.score || 0}
                            </div>
                            <button class="vote-btn downvote ${downvoteClass}" data-id="${track.id}" data-value="-1">
                                üëé
                            </button>
                        </div>
                        <img src="${track.cover}" alt="${track.title}" class="track-cover">
                        <div class="track-info">
                            <div class="track-title">${escapeHtml(track.title)} ${track.explicit ? 'üÖ¥' : ''}</div>
                            <div class="track-artist">${escapeHtml(track.artist)}</div>
                            <div class="track-duration">${formatDuration(track.duration)}</div>
                        </div>
                        ${hasPreview ? `
                            <button class="play-preview ${playBtnClass}" data-url="${track.preview}">
                                ${playBtnIcon}
                            </button>
                        ` : `
                            <button class="play-preview" disabled>
                                ‚è∏
                            </button>
                        `}
                        <button class="admin-btn info-btn" onclick='showTrackInfo(${JSON.stringify(track).replace(/'/g, "&apos;")})'>
                            ‚ÑπÔ∏è
                        </button>
                        <div class="admin-controls ${isAdmin ? 'active' : ''}">
                            <button class="admin-btn replace-btn" onclick='openReplaceModal(${JSON.stringify(track).replace(/'/g, "&apos;")})'>
                                üîÑ
                            </button>
                            <button class="admin-btn delete-btn" onclick="deleteTrack('${track.id}')">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `}).join('');

                document.querySelectorAll('.vote-btn:not(.voted)').forEach(btn => {
                    btn.addEventListener('click', function() {
                        vote(this.dataset.id, parseInt(this.dataset.value), this);
                    });
                });

                document.querySelectorAll('.play-preview:not(:disabled)').forEach(btn => {
                    btn.addEventListener('click', function() {
                        playPreview(this.dataset.url, this);
                    });
                    
                    if (btn.dataset.url === currentPlayingUrl) {
                        currentPlayingBtn = btn;
                    }
                });
            });
        }

        // ===== SEARCH EVENTS =====
        searchInput.addEventListener('input', (e) => {
            debouncedSearch(e.target.value);
        });

        searchBtn.addEventListener('click', () => {
            searchAllAPIs(searchInput.value);
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchAllAPIs(searchInput.value);
            }
        });

        // ===== UTILITY FUNCTIONS =====
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLoading(element) {
            element.innerHTML = '<div class="loading"><div class="spinner"></div><p>Chargement...</p></div>';
        }

        function showNotification(message, type = 'success') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            document.body.appendChild(notif);

            setTimeout(() => {
                notif.remove();
            }, 3000);
        }

        // ===== INIT =====
        getSpotifyToken().then(() => {
            console.log('‚úÖ Spotify token r√©cup√©r√©');
        });
        
        loadPlaylist();
    </script>
</body>
</html>
